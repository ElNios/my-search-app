<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>虛擬瀏覽器</title>
<style>
body { font-family: Arial; margin:0; padding:0; background:#f5f5f5;}
#topBar { background:#eee; padding:8px; display:flex; align-items:center; }
#query { flex:1; padding:6px; font-size:14px; }
button { margin-left:5px; padding:5px 10px; font-size:14px; }
#tabs { display:flex; background:#ddd; padding:4px; overflow-x:auto; }
.tabButton { position:relative; padding:4px 10px; margin-right:2px; cursor:pointer; border:none; background:#ccc; border-radius:4px; }
.tabButton.active { background:#fff; font-weight:bold; }
.tabButton .closeBtn { position:absolute; right:2px; top:0px; color:red; cursor:pointer; font-weight:bold; }
#results { padding:10px; }
.tabContent { display:none; border-top:1px solid #ccc; height:500px; padding:5px; overflow:auto; background:#fff; }
.tabContent.active { display:block; }
iframe, img, video { width:100%; height:auto; margin-bottom:5px; }
</style>
</head>
<body>

<div id="topBar">
  <input id="query" placeholder="輸入關鍵字搜尋">
  <button onclick="search('web')">搜尋</button>
</div>

<div id="results"></div>
<div id="tabs"></div>

<script>
const BASE_URL = "";
let tabs = [];

async function search(type='web'){
  const q = document.getElementById("query").value.trim();
  if(!q) return alert("請輸入關鍵字");
  try{
    const res = await fetch(`${BASE_URL}/search?q=${encodeURIComponent(q)}&type=web`);
    const data = await res.json();

    let html = "";
    if(data.items && data.items.length>0){
      data.items.forEach(item=>{
        html += `<div><a onclick="openTab('${item.link}','${item.title}')">${item.title}</a></div>`;
      });
    }else html = "<p>❌ 找不到結果</p>";
    document.getElementById("results").innerHTML = html;
  }catch(err){
    console.error(err);
    document.getElementById("results").innerHTML = "<p>❌ 搜尋失敗</p>";
  }
}

function openTab(url,title){
  let existing = tabs.find(t=>t.url===url);
  if(existing){ activateTab(existing.id); return; }

  const tabId = `tab${tabs.length+1}`;

  const tabButton = document.createElement("button");
  tabButton.className = "tabButton active";
  tabButton.id = `btn_${tabId}`;
  tabButton.innerHTML = `${title}<span class="closeBtn" onclick="closeTab('${tabId}')">x</span>`;
  tabButton.onclick = (e)=>{
    if(e.target.classList.contains('closeBtn')) return;
    activateTab(tabId);
  };
  document.getElementById("tabs").appendChild(tabButton);

  const tabContent = document.createElement("div");
  tabContent.id = tabId;
  tabContent.className = "tabContent active";

  fetch(`${BASE_URL}/proxy?url=${encodeURIComponent(url)}`)
    .then(res=>res.text())
    .then(html=> tabContent.innerHTML = html)
    .catch(()=> window.open(url,"_blank"));

  deactivateAllTabs();
  document.getElementById("tabs").appendChild(tabContent);
  tabs.push({id:tabId,url,title});
}

function activateTab(tabId){
  tabs.forEach(t=>{
    document.getElementById(t.id).classList.remove("active");
    document.getElementById("btn_"+t.id).classList.remove("active");
  });
  document.getElementById(tabId).classList.add("active");
  document.getElementById("btn_"+tabId).classList.add("active");
}

function deactivateAllTabs(){
  tabs.forEach(t=> {
    document.getElementById(t.id).classList.remove("active");
    document.getElementById("btn_"+t.id).classList.remove("active");
  });
}

function closeTab(tabId){
  const tab = tabs.find(t=>t.id===tabId);
  if(!tab) return;
  document.getElementById(tabId).remove();
  document.getElementById("btn_"+tabId).remove();
  tabs = tabs.filter(t=>t.id!==tabId);
  if(tabs.length>0) activateTab(tabs[tabs.length-1].id);
}
</script>
</body>
</html>
